<html>
 <head>
  <script async defer src="./ui.js"></script>
  <script type="module">
    import { I2CWebBus } from './i2c-web-bus.js'

    //import { I2CAddressedBus } from './i2c-addressed.js'
    import { I2CAddressedBus } from './node_modules/@johntalton/and-other-delights/lib/aod.js'
    //import { I2CAddressedBus } from './aod.min.js'

    import { Tca9548a } from './node_modules/@johntalton/tca9548a/src/index.js'

    async function connect() {
      const ws = new WebSocket('ws://localhost:9000/bus/1', [ 'i2c', 'json' ])
      ws.onerror = event => console.warn('webSocket error', event)
      ws.onclose = event => console.log('webSocket close', event.code, event.reason)
      //ws.onopen = event => sendTestScript(ws)
      //ws.onmessage = event => ui_insert(MessageTransform.stringMessageToMessage(event.data))

      const bus = await I2CWebBus.openPromisified(ws)

      ws.onopen = event => connectToBus(bus)
      ws.onmessage = event => I2CWebBus.onMessage(bus, event.data)

    }

    async function connectToBus(bus) {
      const ab = new I2CAddressedBus(bus, 0x70)
      const tca = await Tca9548a.from(ab)

      try {
        const initialChannels = await tca.getChannels()
        console.log({ initialChannels })

        await tca.setChannels([ 3, 5 ])

        const channels = await tca.getChannels()
        console.log({ channels })
      } catch(e) {
        console.warn('tca exception', e)
      }
    }


    const uiScriptElem = document.querySelector('script[src = "./ui.js"]')
    uiScriptElem.onload = event => console.log('ui Load', event)

    connect()

    document.addEventListener("DOMContentLoaded", () => { console.log('DOM Content Loaded');  })
  </script>
 </head>
 <body>
   <!-- table>
    <th>Reg</th> <th>hex</th> <th>dec</th>  <th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th><th>0</th>
    <tr id="0xff">
      <td>0xff</td> <th>0</th><th>0</th>    <th>0</th><th>0</th><th>1</th><th>1</th><th>1</th><th>1</th><th>0</th><th>0</th>
    </tr>
    <tr id="0x1b">
      <td>0x1b</td> <th>0</th><th>0</th>   <th>0</th><th>0</th><th>1</th><th>1</th><th>1</th><th>1</th><th>0</th><th>0</th>
    </tr>
   </table -->
  <ul id="list">
  </ul>
 </body>
</html>
